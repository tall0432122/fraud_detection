<!DOCTYPE html>
<html lang="{{ get_locale() }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ _('batch_analysis_results') }} - FraudGuard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        }
        .table th {
            border-top: none;
            font-weight: 600;
        }
        .progress {
            height: 20px;
            border-radius: 10px;
        }
        .badge {
            font-size: 0.75em;
        }
    </style>
</head>
<body class="d-flex flex-column min-vh-100">
    <!-- Navigation -->
    {% include 'navbar.html' %}

    <!-- Contenu Principal -->
    <main class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>{{ _('batch_analysis_results') }}
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- Résumé des résultats -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5 class="card-title text-primary">{{ results|length }}</h5>
                                        <p class="card-text">{{ _('analyzed_transactions') }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5 class="card-title text-success">
                                            {{ results|selectattr('prediction', 'equalto', 'Sécurisé')|list|length }}
                                        </h5>
                                        <p class="card-text">{{ _('safe_transactions') }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5 class="card-title text-danger">
                                            {{ results|selectattr('prediction', 'equalto', 'Fraude')|list|length }}
                                        </h5>
                                        <p class="card-text">{{ _('fraudulent_transactions') }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5 class="card-title text-warning">
                                            {% if results|length > 0 %}
                                                {{ "%.2f"|format((results|selectattr('prediction', 'equalto', 'Fraude')|list|length / results|length * 100)) }}%
                                            {% else %}
                                                0%
                                            {% endif %}
                                        </h5>
                                        <p class="card-text">{{ _('fraud_rate') }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Filtres -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <input type="text" class="form-control" id="searchInput" placeholder="{{ _('search') }}...">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="statusFilter">
                                    <option value="">{{ _('all_statuses') }}</option>
                                    <option value="Fraude">{{ _('fraud') }}</option>
                                    <option value="Sécurisé">{{ _('secure') }}</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="confidenceFilter">
                                    <option value="">{{ _('all_confidence') }}</option>
                                    <option value="high">{{ _('high_confidence') }} (>90%)</option>
                                    <option value="medium">{{ _('medium_confidence') }} (70-90%)</option>
                                    <option value="low">{{ _('low_confidence') }} (<70%)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Tableau des résultats -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>{{ _('transaction_id') }}</th>
                                        <th>{{ _('amount') }}</th>
                                        <th>{{ _('prediction') }}</th>
                                        <th>{{ _('confidence') }}</th>
                                        <th>{{ _('status') }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for result in results %}
                                    <tr class="{% if result.prediction == 'Fraude' %}table-danger{% endif %}">
                                        <td>{{ result.transaction_id }}</td>
                                        <td>${{ "%.2f"|format(result.amount) }}</td>
                                        <td>
                                            <span class="badge {% if result.prediction == 'Fraude' %}bg-danger{% else %}bg-success{% endif %}">
                                                {% if result.prediction == 'Fraude' %}
                                                    {{ _('fraud') }}
                                                {% else %}
                                                    {{ _('secure') }}
                                                {% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="progress">
                                                <div class="progress-bar {% if result.prediction == 'Fraude' %}bg-danger{% else %}bg-success{% endif %}" 
                                                     style="width: {{ result.confidence * 100 }}%">
                                                    {{ "%.1f"|format(result.confidence * 100) }}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            {% if result.prediction == 'Fraude' %}
                                                <i class="fas fa-exclamation-triangle text-danger"></i>
                                                <span class="text-danger">{{ _('to_verify') }}</span>
                                            {% else %}
                                                <i class="fas fa-check-circle text-success"></i>
                                                <span class="text-success">{{ _('normal') }}</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Actions -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="{{ url_for('batch_prediction') }}" class="btn btn-outline-primary">
                                        <i class="fas fa-arrow-left me-2"></i>{{ _('new_analysis') }}
                                    </a>
                                    <div>
                                        <button class="btn btn-success me-2" onclick="exportToCSV()">
                                            <i class="fas fa-download me-2"></i>{{ _('export_csv') }}
                                        </button>
                                        <button class="btn btn-warning" onclick="generateReport()">
                                            <i class="fas fa-file-pdf me-2"></i>{{ _('generate_report') }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="mt-auto py-3 bg-light">
        <div class="container text-center">
            <span class="text-muted">{{ _('fraudguard_system') }} - {{ _('master_dsgl') }} - {{ _('university_bambey') }}</span>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Filtrage du tableau
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const statusFilter = document.getElementById('statusFilter');
            const confidenceFilter = document.getElementById('confidenceFilter');
            const tableRows = document.querySelectorAll('tbody tr');

            function filterTable() {
                const searchTerm = searchInput.value.toLowerCase();
                const statusValue = statusFilter.value;
                const confidenceValue = confidenceFilter.value;

                tableRows.forEach(row => {
                    const cells = row.getElementsByTagName('td');
                    const id = cells[0].textContent.toLowerCase();
                    const amount = cells[1].textContent.toLowerCase();
                    const status = cells[2].textContent;
                    const confidenceText = cells[3].textContent;
                    const confidence = parseFloat(confidenceText);

                    const matchesSearch = id.includes(searchTerm) || amount.includes(searchTerm);
                    const matchesStatus = !statusValue || status.includes(statusValue);
                    let matchesConfidence = true;

                    if (confidenceValue === 'high') matchesConfidence = confidence > 90;
                    else if (confidenceValue === 'medium') matchesConfidence = confidence >= 70 && confidence <= 90;
                    else if (confidenceValue === 'low') matchesConfidence = confidence < 70;

                    if (matchesSearch && matchesStatus && matchesConfidence) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            searchInput.addEventListener('input', filterTable);
            statusFilter.addEventListener('change', filterTable);
            confidenceFilter.addEventListener('change', filterTable);
        });

        function exportToCSV() {
            alert('{{ _("csv_export_functionality") }}');
        }

        function generateReport() {
            alert('{{ _("pdf_report_functionality") }}');
        }
    </script>
</body>
</html>